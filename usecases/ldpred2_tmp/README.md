# examples

## LDpred2.Rmd

We here provide an R markdown file (`LDpred2.Rmd`) which can be executed using R directly, or built containers either in Docker (locally) or Singularity (typically HPC) formats.
The R script is based on an example/tutorial from the [`bigsnpr` GitHub repository](https://github.com/privefl/bigsnpr),
specifically [R markdown file](https://github.com/privefl/bigsnpr/blob/master/vignettes/LDpred2.Rmd).
**bigsnpr** is released under the GPL-3 license (<https://privefl.github.io/bigsnpr/>), and files provided here retains this license.

Please confer this [tutorial](https://privefl.github.io/bigsnpr/articles/LDpred2.html) for additional explainations of the actual codes.

The main difference from the original file is that data and summary stats files used (in `/tutorial_data/`) is included in this repository
and should not require any other external data to run.

In order to run the R notebook, issue in the terminal:

```
R -e "rmarkdown::render('LDpred2.Rmd')"
```

Opening the file in Rstudio and executing it in this environment should also work. 

Installing missing packages from [CRAN](https://cran.r-project.org/web/packages/available_packages_by_name.html) may be performed via the Rstudio GUI or in the terminal as

```
R -e "install.packages('<missing-package>', version='X.Y.Z', repos='http://cran.us.r-project.org')"
```

### Output

The files generated by running the R notebook `LDpred2.Rmd` are:

- `LDpred2.pdf`: Rendered notebook and output in PDF file format compiled via LaTeX
- `Rplots.pdf`: Figure output
- `LDpred2_cache/`: misc. cache files
- `LDpred2_files/`: misc. files
- `tutorial_data/*.sbk`, `tutorial_data/*.bk`:

### `tutorial_data` directory

This directory includes some files used by the [tutorial](https://privefl.github.io/bigsnpr/articles/LDpred2.html) here included in the directory from
[https://figshare.com/ndownloader/files/37802721](https://figshare.com/ndownloader/files/37802721) and [github.com/privefl/bigsnpr/raw/master/data-raw/public-data3.zip](https://github.com/privefl/bigsnpr/raw/master/data-raw/public-data3.zip)

## Docker

Run using [Docker](https://www.docker.com) container, e.g., for local testing/development without Singularity

In case you wish to build the image, clone the entire repository, change directory to this one and issue

```
docker build -t ldpred2 -f ../src/dockerfiles/ldpred2/Dockerfile .
```

The build may take some time, and is assigned the ID `ldpred2`.

Then, one may mount the working directory to `/rscripts/` and run the example using `R` as:

```
docker run -p 49634:49634 --mount type=bind,source=$(pwd),target=/home/ ldpred2 R -e "rmarkdown::render('/home/LDpred2.Rmd')"
```

## Singularity

Get familiar with Singularity:

* ["singularity shell" options](https://sylabs.io/guides/3.2/user-guide/cli/singularity_shell.html#options)
* [Bind paths and mounts](https://sylabs.io/guides/3.2/user-guide/bind_paths_and_mounts.html).

In order to run the example from the terminal using Singularity, issue:

```
export SIF=$PWD/../containers/ldpred2.sif  # point to ldpred2.sif file. Modify as needed.
export R="singularity exec --home=$PWD:/home $SIF R"  # invokes R binding the working directory as "home" directory
$R -e "rmarkdown::render('LDpred2.Rmd')"  # Run .Rmd file using R
```

## Singularity + Slurm

For running the script on a HPC facility with the [SLURM](https://slurm.schedmd.com/quickstart.html) scheduler that also use Singularity , 
first we create a job script (`LDpred2_slurm.job`) as:
```
#!/bin/bash
#SBATCH --job-name=LDpred2  # job name
#SBATCH --output=LDpred2.txt  # R output
#SBATCH --error=LDpred2.txt  # errors
#SBATCH --account=$SBATCH_ACCOUNT  # project ID
#SBATCH --time=00:15:00  # walltime
#SBATCH --cpus-per-task=1  # number of CPUS for task
#SBATCH --mem-per-cpu=2000  # memory (MB)

module load singularity  # load singularity

export SIF=$PWD/../containers/ldpred2.sif  # point to container file
export R="singularity exec --home=$PWD:/home $SIF R"  # alias for R
$R -e "rmarkdown::render('LDpred2.Rmd')"  # execute script
```

To submit the job, first export the ID of the compute time/project, and call `sbatch` as:
```
export SBATCH_ACCOUNT=<project ID>  # could be useful to put in ~/.bashrc or equivalent file
sbatch LDPred2_slurm.job
```

Running jobs can then be listed issuing `watch squeue -u $USER`. 
The submitted job will include `LDpred2` in the `NAME` column. 
If nothing is listed the job either finished or terminated due to an error.
R output and error messages will be logged to the file `LDpred2.txt` in this directory. 


## Read only file systems

The codes provided here may be on a read-only file system (e.g., on a partition on a secure cluster). 
In order to use them, copy the codes to a file system location where you may have write access, 
e.g., a `$PROJECT`, `$WORK`, `$HOME`, `$SCRATCH` or similar area. 
Syncing the files to another location may be done using the `rsync` utility 
(here creating a local copy in the `$HOME` directory):
```
rsync -avh <absolute/path/to/ldpred2> $HOME
```
Then, all files should be present in the the directory `$HOME/ldpred2`. 